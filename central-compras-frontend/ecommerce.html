<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>E-commerce — Pedido</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">Central de Compras</div>
    <nav>
      <a href="dashboard.html">Dashboard</a>
      <a href="fornecedores.html">Fornecedores</a>
      <a href="campanhas.html">Campanhas</a>
      <a href="cashback.html">Cashback</a>
      <a href="index.html">Sair</a>
    </nav>
  </header>

  <main class="container">
    <h1>Formulário de Pedido</h1>
    <div id="fornecedorHeader" class="card"></div>

    <form id="orderForm" class="card full">
      <h3>Produtos</h3>
      <div id="productList"></div>

      <h3>Opções</h3>
      <label><input type="checkbox" name="pgto" value="avista" /> Pagamento à vista</label>
      <label><input type="checkbox" name="orçamento" value="sim" /> Considerar como orçamento</label>
      <label>Observações</label>
      <textarea id="obs" placeholder="Observações sobre horário de descarga, trocas, etc."></textarea>

      <div class="row between">
        <div class="muted">Total: <span id="orderTotal">R$ 0.00</span></div>
        <div>
          <button type="button" class="btn alt" onclick="location.href='fornecedores.html'">Voltar</button>
          <button type="submit" class="btn primary">Enviar Pedido</button>
        </div>
      </div>
    </form>
  </main>

  <script src="js/data.js"></script>
  <script src="js/app.js"></script>
  <script>
    appAuth.maybeRequireLogin();

    const params = new URLSearchParams(location.search);
    const fornecedorId = params.get('fornecedor') || db.getFornecedores()[0].id;
    const f = db.getFornecedor(fornecedorId);
    document.getElementById('fornecedorHeader').innerHTML = `<h2>${f.name}</h2><p class="muted">${f.description}</p>`;

    const productList = document.getElementById('productList');
    let cart = [];
    function renderProducts(){
      productList.innerHTML = '';
      f.products.forEach(p=>{
        const div = document.createElement('div');
        div.className='product-row';
        div.innerHTML = `
          <div>
            <strong>${p.name}</strong><div class="muted small">${p.desc || ''}</div>
          </div>
          <div>
            <span>R$ ${p.price.toFixed(2)}</span>
            <input type="number" min="0" value="0" style="width:70px" onchange="updateQty('${p.id}',this.value)" />
          </div>
        `;
        productList.appendChild(div);
      });
    }

    function updateQty(prodId, qty){
      qty = Number(qty);
      const p = f.products.find(x=>x.id===prodId);
      const existing = cart.find(x=>x.id===prodId);
      if(qty<=0){
        if(existing) cart = cart.filter(x=>x.id!==prodId);
      } else {
        if(existing) existing.qty = qty; else cart.push({id:prodId, name:p.name, price:p.price, qty});
      }
      updateTotal();
    }

    function updateTotal(){
      const total = cart.reduce((s,i)=>s + i.price*i.qty, 0);
      document.getElementById('orderTotal').textContent = `R$ ${total.toFixed(2)}`;
    }

    document.getElementById('orderForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      if(cart.length===0){ alert('Adicione pelo menos um produto'); return; }
      const obs = document.getElementById('obs').value;
      const order = db.createOrder({
        fornecedorId: f.id,
        fornecedorName: f.name,
        items: cart,
        obs,
        total: cart.reduce((s,i)=>s+i.price*i.qty,0)
      });
      alert('Pedido enviado! ID: ' + order.id + '\nUma cópia foi salva localmente (simulação).');
      location.href = 'dashboard.html';
    });

    renderProducts();
    updateTotal();
  </script>
</body>
</html>
